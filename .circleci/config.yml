version: 2.1

workflows:
  version: 2
  linux-python-3.8-rc:
    jobs:
      - linux-build:
          tag: 3.8-rc
  # all versions released after August 2017 (~2 years ago)
  linux-python-3.7.4:
    jobs:
      - linux-build:
          tag: 3.7.4
  linux-python-3.7.3:
    jobs:
      - linux-build:
          tag: 3.7.3
  linux-python-3.7.2:
    jobs:
      - linux-build:
          tag: 3.7.2
  linux-python-3.7.1:
    jobs:
      - linux-build:
          tag: 3.7.1
  linux-python-3.7.0:
    jobs:
      - linux-build:
          tag: 3.7.0
  linux-python-3.6.9:
    jobs:
      - linux-build:
          tag: 3.6.9
  linux-python-3.6.8:
    jobs:
      - linux-build:
          tag: 3.6.8
  linux-python-3.6.7:
    jobs:
      - linux-build:
          tag: 3.6.7
  linux-python-3.6.6:
    jobs:
      - linux-build:
          tag: 3.6.6
  linux-python-3.6.5:
    jobs:
      - linux-build:
          tag: 3.6.5
  linux-python-3.6.4:
    jobs:
      - linux-build:
          tag: 3.6.4
  linux-python-3.6.3:
    jobs:
      - linux-build:
          tag: 3.6.3
  linux-python-3.5.7:
    jobs:
      - linux-build:
          tag: 3.5.7
  linux-python-3.5.6:
    jobs:
      - linux-build:
          tag: 3.5.6
  linux-python-3.5.5:
    jobs:
      - linux-build:
          tag: 3.5.5
  linux-python-3.4.10:
    jobs:
      - linux-build:
          tag: 3.4.10
  linux-python-3.4.9:
    jobs:
      - linux-build:
          tag: 3.4.9
  linux-python-3.4.8:
    jobs:
      - linux-build:
          tag: 3.4.8
  linux-python-3.3.7:
    jobs:
      - linux-build:
          tag: 3.3.7
  linux-python-2.7.16:
    jobs:
      - linux-build:
          tag: 2.7.16
  linux-python-2.7.15:
    jobs:
      - linux-build:
          tag: 2.7.15
  linux-python-2.7.14:
    jobs:
      - linux-build:
          tag: 2.7.14

executors:
  linux-python:
    parameters:
      tag:
        type: string

    docker:
      - image: circleci/python:<< parameters.tag >>

    working_directory: ~/repo

jobs:
  linux-build:
    parameters:
      tag:
        type: string

    executor:
      name: linux-python
      tag: << parameters.tag >>

    steps:
      - checkout

      - restore_cache:
          keys:
            - v1-dependencies-{{ arch }}-{{ checksum "requirements.txt" }}
            - v1-dependencies-{{ arch }}-

      - run:
          name: Setup Virtual Environment
          command: |
            python3 -m venv .env
            . .env/bin/activate
            python -m pip install -U pip setuptools
            pip install -r requirements.txt

      - save_cache:
          key: v1-dependencies-{{ arch }}-{{ checksum "requirements.txt" }}
          paths:
            - .env

      - run:
          name: run tests
          command: |
            . .env/bin/activate
            make coverage
            coveralls
            mv .coverage coverage.xml htmlcov

      - store_artifacts:
          path: htmlcov
